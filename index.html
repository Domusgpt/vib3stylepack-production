<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperAV - 4D Visualizer</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; color: #fff; font-family: Arial, sans-serif; }
        canvas#hypercubeCanvas { display: block; width: 100vw; height: 100vh; }
        /* Dashboard container will be positioned by its own CSS or JS from DashboardUIManager */
    </style>
    <!-- CRITICAL: Load gl-matrix library first -->
    <script src="https://unpkg.com/gl-matrix@3.4.3/gl-matrix-min.js"></script>
    <script>
        // Make glMatrix components globally accessible as mat4, vec3 etc. for convenience
        // This should be done after gl-matrix.js is loaded and before other project scripts.
        if (typeof glMatrix !== 'undefined') {
            window.mat4 = glMatrix.mat4;
            window.vec3 = glMatrix.vec3;
            window.vec4 = glMatrix.vec4;
            window.quat = glMatrix.quat;
            window.mat3 = glMatrix.mat3; // Important for normal matrix in shaders
        } else {
            console.error("CRITICAL ERROR: gl-matrix library was not loaded! Application will likely fail.");
            // Fallback to basic mocks if glMatrix is missing, though shaders will likely still fail
            // This is NOT a substitute for including the actual library.
            if (typeof mat4 === 'undefined') {
                console.warn('Using placeholder mat4 because glMatrix is missing.');
                window.mat4 = {
                    create: () => [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],
                    identity: (out) => { out.fill(0); out[0]=out[5]=out[10]=out[15]=1; return out; },
                    lookAt: (out, eye, center, up) => out,
                    perspective: (out, fovy, aspect, near, far) => out,
                    ortho: (out, l, r, b, t, n, f) => out,
                    multiply: (out, a, b) => out, // Simplified mock
                    translate: (out, a, v) => out, 
                    rotate: (out, a, rad, axis) => out,
                    scale: (out, a, v) => out,
                    invert: (out, a) => out, // Mock - does not actually invert
                    transpose: (out, a) => out // Mock - does not actually transpose
                };
                window.mat3 = { // Basic mat3 mock if needed by JS, shaders need real glMatrix
                     create: () => new Array(9).fill(0), identity: (out) => out, fromMat4:(out,a) => out, invert:(out,a)=>out, transpose:(out,a)=>out
                };
            }
        }
    </script>
</head>
<body>
    <canvas id="hypercubeCanvas"></canvas>
    <div id="hyperAVDashboardContainer">
        <!-- DashboardUIManager.js will populate this -->
    </div>

    <!-- Core Architecture -->
    <script src="js/core/BaseGeometry.js"></script>
    <script src="js/core/BaseProjection.js"></script>
    <script src="js/managers/ShaderManager.js"></script>
    <script src="js/managers/GeometryManager.js"></script>
    <script src="js/managers/ProjectionManager.js"></script>

    <!-- Geometries -->
    <script src="js/geometries/HypercubeGeometry.js"></script>
    <script src="js/geometries/HypersphereGeometry.js"></script>
    <script src="js/geometries/HypertetrahedronGeometry.js"></script>
    <script src="js/geometries/TorusGeometry.js"></script>
    <script src="js/geometries/KleinBottleGeometry.js"></script>
    <script src="js/geometries/FractalGeometry.js"></script>
    <script src="js/geometries/WaveGeometry.js"></script>
    <script src="js/geometries/CrystalGeometry.js"></script>

    <!-- Projections -->
    <script src="js/projections/PerspectiveProjection.js"></script>
    <script src="js/projections/OrthographicProjection.js"></script>
    <script src="js/projections/StereographicProjection.js"></script>

    <!-- Interaction System -->
    <script src="js/interaction/VIB34DInteractionEngine.js"></script>
    <script src="js/interaction/ParameterMappingSystem.js"></script>

    <!-- Chromatic System -->
    <script src="js/chromatic/VIB34DChromaticEngine.js"></script>

    <!-- Bridge -->
    <script src="js/bridge/VIB3HomeMasterBridge.js"></script>

    <!-- Config (Presets & PresetManager) -->
    <script src="js/config/presets.js"></script> 
    
    <!-- Main Core Logic -->
    <script src="js/core/HypercubeCore.js"></script>

    <!-- UI Manager -->
    <script src="js/ui/DashboardUIManager.js"></script>

    <!-- Main Application Instantiation Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('hypercubeCanvas');
            if (canvas) {
                try {
                    const core = new HypercubeCore(canvas, {
                        onStateChangeCallback: (reason) => {
                            if (window.hyperAVDashboard && typeof window.hyperAVDashboard.syncDashboardToCoreState === 'function') {
                                // console.log(`HypercubeCore state changed: ${reason}. Syncing dashboard.`);
                                window.hyperAVDashboard.syncDashboardToCoreState();
                            }
                        }
                    });
                    window.core = core; // Make core global for easy console access/debugging

                    if (typeof DashboardUIManager !== 'undefined') {
                        window.hyperAVDashboard = new DashboardUIManager(core, 'hyperAVDashboardContainer');
                    } else {
                        console.warn("DashboardUIManager class not found. Dashboard will not be initialized. Make sure js/ui/DashboardUIManager.js is created and loaded before this script.");
                    }

                    // Register all known geometries and projections
                    if (typeof HypercubeGeometry !== 'undefined') core.geometryManager.registerGeometry('hypercube', HypercubeGeometry);
                    if (typeof HypersphereGeometry !== 'undefined') core.geometryManager.registerGeometry('hypersphere', HypersphereGeometry);
                    if (typeof HypertetrahedronGeometry !== 'undefined') core.geometryManager.registerGeometry('hypertetrahedron', HypertetrahedronGeometry);
                    if (typeof TorusGeometry !== 'undefined') core.geometryManager.registerGeometry('torus', TorusGeometry);
                    if (typeof KleinBottleGeometry !== 'undefined') core.geometryManager.registerGeometry('kleinbottle', KleinBottleGeometry);
                    if (typeof FractalGeometry !== 'undefined') core.geometryManager.registerGeometry('fractal', FractalGeometry);
                    if (typeof WaveGeometry !== 'undefined') core.geometryManager.registerGeometry('wave', WaveGeometry);
                    if (typeof CrystalGeometry !== 'undefined') core.geometryManager.registerGeometry('crystal', CrystalGeometry);

                    if (typeof PerspectiveProjection !== 'undefined') core.projectionManager.registerProjection('perspective', PerspectiveProjection);
                    if (typeof OrthographicProjection !== 'undefined') core.projectionManager.registerProjection('orthographic', OrthographicProjection);
                    if (typeof StereographicProjection !== 'undefined') core.projectionManager.registerProjection('stereographic', StereographicProjection);
                    
                    if (core.presetManager && typeof VIB3_PRESETS_EXPANDED !== 'undefined' && VIB3_PRESETS_EXPANDED.length > 0) {
                        core.presetManager.loadPresetByName(VIB3_PRESETS_EXPANDED[0].name);
                    } else {
                        core.setGeometry('hypercube'); 
                        core.setProjection('perspective');
                    }
                    
                    core.start();

                } catch (error) {
                    console.error("Failed to initialize HypercubeCore:", error);
                    document.body.innerHTML = `<p>Error: ${error.message}. Please ensure your browser supports WebGL and all scripts are loaded correctly.</p>`;
                }
            } else {
                console.error("Canvas element #hypercubeCanvas not found.");
            }
        });
    </script>
</body>
</html>